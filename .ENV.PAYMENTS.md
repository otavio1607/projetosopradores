# Configura√ß√£o de Pagamentos e Licenciamento

## Vari√°veis de Ambiente

### Stripe (Pagamentos)
```env
# Stripe Keys
VITE_STRIPE_PUBLIC_KEY=pk_live_XXXXXXXXXXXXXXxx
STRIPE_SECRET_KEY=sk_live_XXXXXXXXXXXXXXxx
STRIPE_WEBHOOK_SECRET=whsec_XXXXXXXXXXXXXXxx

# Modo
VITE_STRIPE_MODE=production  # ou 'test'
```

### Pix
```env
# Mercado Pago (para Pix)
VITE_MERCADOPAGO_PUBLIC_KEY=APP_USR-XXXXXXXXXXXXXXx
MERCADOPAGO_ACCESS_TOKEN=APP_USR-XXXX-XXXXXXXXXXXXXXx

# OU Stripe (tamb√©m suporta Pix)
STRIPE_PIX_ENABLED=true
```

### Transfer√™ncia Banc√°ria
```env
# Dados banc√°rios da empresa (para receber transfer√™ncias)
BANK_CODE=001                    # 001 = Banco do Brasil
BANK_AGENCY=0001
BANK_ACCOUNT=12345
BANK_ACCOUNT_DIGIT=6
BANK_ACCOUNT_TYPE=checking       # ou 'savings'
BANK_RECIPIENT_NAME=Sua Empresa LTDA
BANK_RECIPIENT_DOCUMENT=12345678000190

# Status banc√°rio (para tracking de pagamentos)
BANK_API_KEY=seu_api_key_do_banco
BANK_API_SECRET=seu_api_secret
```

### Email (Notifica√ß√µes)
```env
# SendGrid (para enviar emails de confirma√ß√£o)
SENDGRID_API_KEY=SG.XXXXXXXXXXXXXXx
SENDGRID_FROM_EMAIL=noreply@seudominio.com

# OU usar outro servi√ßo
MAIL_SERVICE=sendgrid      # sendgrid, mailgun, postmark
```

### Sistema de Licen√ßa
```env
# Servidor de valida√ß√£o de licen√ßas
VITE_LICENSE_VALIDATION_URL=https://api.seudominio.com/v1/licenses
LICENSE_SECRET_KEY=sua_chave_secreta_para_gerar_licencas
LICENSE_VALIDATION_INTERVAL=86400000  # 24h em ms

# Offline support (pra validar sem internet)
LICENSE_OFFLINE_MODE=true
```

### Banco de Dados
```env
# Supabase (para armazenar licen√ßas e pagamentos)
VITE_SUPABASE_URL=https://xxxx.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGc...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc...
```

### Geral
```env
# URLs
VITE_API_BASE_URL=https://api.seudominio.com
VITE_APP_URL=https://seudominio.com

# Modo
NODE_ENV=production     # ou 'development'
```

---

## Setup Passo a Passo

### 1. Stripe (Recomendado para Pix + Cart√£o)

1. **Criar conta em stripe.com**
   ```
   https://dashboard.stripe.com/register
   ```

2. **Ativar Pix como m√©todo de pagamento**
   - Settings ‚Üí Payment Methods
   - Ativar "PIX"
   - Seguir instru√ß√µes para registrar chave Pix do Banco

3. **Gerar chaves de teste**
   - Developers ‚Üí API Keys
   - Copiar `pk_test_...` para VITE_STRIPE_PUBLIC_KEY
   - Copiar `sk_test_...` para STRIPE_SECRET_KEY

4. **Configurar webhook**
   - Developers ‚Üí Webhooks
   - Adicionar endpoint: `https://seudominio.com/api/webhooks/stripe`
   - Selecionar eventos: `payment_intent.succeeded`, `payment_intent.payment_failed`
   - Copiar assinatura para STRIPE_WEBHOOK_SECRET

5. **Testar com n√∫meros/dados fict√≠cios**
   ```
   Cart√£o teste: 4242 4242 4242 4242
   Exp: 12/25, CVC: 123
   ```

### 2. Mercado Pago (Alternativa para Pix)

1. **Criar conta em mercadopago.com.br**

2. **Gerar credenciais**
   - Conta ‚Üí Credenciais
   - Copiar Public Key e Access Token

3. **Configurar em .env**
   ```env
   VITE_MERCADOPAGO_PUBLIC_KEY=APP_USR_...
   MERCADOPAGO_ACCESS_TOKEN=APP_USR_...
   ```

### 3. SendGrid (E-mails)

1. **Criar conta em sendgrid.com**

2. **Gerar API Key**
   - Settings ‚Üí API Keys
   - Create API Key
   - Copiar para SENDGRID_API_KEY

3. **Verificar dom√≠nio**
   - Sender Authentication
   - Adicionar dom√≠nio e verificar DNS

### 4. Banco para Transfer√™ncias

Ir ao seu banco e:
- Usar dados j√° existentes da sua conta
- Ou solicitar uma conta de neg√≥cios
- Copiar dados para as vari√°veis de environment

### 5. Supabase (Banco de Dados)

**Tabelas Necess√°rias:**

```sql
-- Licen√ßas
CREATE TABLE licenses (
  id UUID PRIMARY KEY,
  key VARCHAR UNIQUE NOT NULL,
  plan_type VARCHAR NOT NULL,
  organization_name VARCHAR NOT NULL,
  organization_email VARCHAR NOT NULL,
  max_equipment INT,
  max_users INT,
  status VARCHAR,
  issued_at TIMESTAMPTZ,
  expires_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Assinaturas
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,
  license_id UUID REFERENCES licenses,
  plan_type VARCHAR NOT NULL,
  billing_cycle VARCHAR,
  status VARCHAR,
  auto_renew BOOLEAN,
  next_billing_date TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Pagamentos
CREATE TABLE payments (
  id UUID PRIMARY KEY,
  subscription_id UUID REFERENCES subscriptions,
  amount DECIMAL,
  currency VARCHAR,
  status VARCHAR,
  payment_method VARCHAR,
  transaction_id VARCHAR,
  paid_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Invoices/Faturas
CREATE TABLE invoices (
  id UUID PRIMARY KEY,
  subscription_id UUID REFERENCES subscriptions,
  invoice_number VARCHAR UNIQUE,
  amount DECIMAL,
  tax DECIMAL,
  total DECIMAL,
  status VARCHAR,
  issue_date TIMESTAMPTZ,
  due_date TIMESTAMPTZ,
  paid_date TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## Exemplos de Vari√°veis (TESTE)

### Stripe Test Mode
```env
VITE_STRIPE_PUBLIC_KEY=pk_test_51J2c7CKVk6iZvC9F5a5Z5a5Z5aZ5aZ5a5a
STRIPE_SECRET_KEY=sk_test_51J2c7CKVk6iZvC9F5a5Z5a5Z5aZ5aZ5a5a
STRIPE_WEBHOOK_SECRET=whsec_test_wh_test1234567890abcdef1234567890abc
```

### Mercado Pago Test Mode
```env
VITE_MERCADOPAGO_PUBLIC_KEY=APP_USR_test_123456789
MERCADOPAGO_ACCESS_TOKEN=TEST-123456789
```

### SendGrid
```env
SENDGRID_API_KEY=SG.test_1234567890abcdef_test1234567890abc
SENDGRID_FROM_EMAIL=test@suaempresa.com
```

---

## Como Ativar M√©todos de Pagamento

### ‚úÖ Est√° Ativado?

**Pix (Stripe)**
```
‚úì Fazer login Stripe
‚úì Vir em Dashboard ‚Üí Payments
‚úì Verificar se "PIX" aparece como m√©todo dispon√≠vel
‚úì Se n√£o, ir em Settings ‚Üí Payment Methods ‚Üí Ativar
```

**Cart√£o (Stripe)**
```
‚úì Por padr√£o j√° vem ativado
‚úì Aceita: Visa, Mastercard, Amex, Elo
```

**Transfer√™ncia**
```
‚úì Sempre dispon√≠vel (usar dados banc√°rios configurados)
```

---

## Testes

### Testar Pix (Stripe)
```bash
# No seu app
# Ir para /billing ‚Üí Escolher plano ‚Üí Selecionar Pix
# Um QR code ser√° gerado
# Scanear com seu celular em modo teste
```

### Testar Cart√£o (Stripe)
```bash
N√∫mero do cart√£o: 4242 4242 4242 4242
Validade: 12/25
CVC: 123
```

### Testar Transfer√™ncia
```
Simular transfer√™ncia para a conta banc√°ria configurada
(N√£o √© poss√≠vel testar em sandbox)
```

---

## Checklist de Configura√ß√£o

- [ ] Criar conta Stripe
- [ ] Gerar chaves Stripe (pk_test e sk_test)
- [ ] Ativar Pix no Stripe
- [ ] Registrar chave Pix do banco
- [ ] Configurar webhook Stripe
- [ ] Criar conta SendGrid
- [ ] Gerar API Key SendGrid
- [ ] Configurar Supabase
- [ ] Criar tabelas no Supabase
- [ ] Adicionar vari√°veis em `.env.local`
- [ ] Adicionar vari√°veis em `.env.production`
- [ ] Testar fluxo completo em desenvolvimento
- [ ] Migrar para chaves de produ√ß√£o
- [ ] Testar com pagamento real

---

## Migrar de Teste para Produ√ß√£o

```env
# Na produ√ß√£o, trocar:

# De (teste):
VITE_STRIPE_PUBLIC_KEY=pk_test_...
STRIPE_SECRET_KEY=sk_test_...

# Para (produ√ß√£o):
VITE_STRIPE_PUBLIC_KEY=pk_live_...
STRIPE_SECRET_KEY=sk_live_...

# Ou com Mercado Pago:
VITE_MERCADOPAGO_PUBLIC_KEY=APP_USR_...  (sem "test_")
```

---

## Monitoramento

### Stripe Dashboard
```
Payments ‚Üí Successful/Failed
Data ‚Üí CSV Download
Webhooks ‚Üí Logs
```

### Logs da Aplica√ß√£o
```
/var/log/payments.log
/var/log/licenses.log
```

### Alertas Importantes
```
- Falha de pagamento
- Licen√ßa expirando
- Licen√ßa expirada
- Renova√ß√£o autom√°tica falhando
```

---

**Setup pronto? Teste agora! üöÄ**
